# 1. 选择调试器接口 (以 DAP-Link 为例)
source [find interface/cmsis-dap.cfg]

# 2. 选择传输协议 (F4 常用 SWD)
transport select swd

# 3. 引入官方 F4 配置文件
# 此时，官方脚本里定义的默认变量（如 _CHIPNAME）已经加载
source [find target/stm32f4x.cfg]

# 4. 覆盖全局时钟频率 (10MHz = 10000kHz)
# 这会覆盖官方脚本末尾的 adapter speed 1800
adapter speed 10000

# 5. 【关键】覆盖 reset-init 事件
# 官方脚本里定义了 reset-init 时将速度降为 4000。
# 如果你不重写这个事件，执行 "reset init" 后速度会掉回 4MHz。
$_TARGETNAME configure -event reset-init {
	# Configure PLL to boost clock to HSI x 4 (64 MHz)
	mww 0x40023804 0x08012008   ;# RCC_PLLCFGR 16 Mhz /8 (M) * 128 (N) /4(P)
	mww 0x40023C00 0x00000102   ;# FLASH_ACR = PRFTBE | 2(Latency)
	mmw 0x40023800 0x01000000 0 ;# RCC_CR |= PLLON
	sleep 10                    ;# Wait for PLL to lock
	mmw 0x40023808 0x00001000 0 ;# RCC_CFGR |= RCC_CFGR_PPRE1_DIV2
	mmw 0x40023808 0x00000002 0 ;# RCC_CFGR |= RCC_CFGR_SW_PLL

	# Boost JTAG frequency
	adapter speed 10000
}

